<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">

<dom-module id="hn-digest">
  <template>
    <h3>{{date}}</h3>
    <table>
      <template is="dom-repeat" items="{{stories}}">
        <tr>
          <td>{{item.score}}</td>
          <td><a href="{{storyUrl(item.id)}}">{{item.descendants}}</a></td>
          <td>{{item.by}}</td>
          <td><a href="{{item.url}}">{{item.title}}</a></td>
        </tr>
      </template>
    </table>
  </template>
</dom-module>

<script>
  Polymer({
    is: "hn-digest",

    properties: {
      stories: Array,
      date: String
    },

    created: function() {
      var self = this;
      console.log(this.localName + '#' + this.id + ' was created');

      var firebase = new Firebase("https://sweltering-heat-9449.firebaseio.com");
      var today = new Date().toISOString().substring(0, 10);
      
      
      firebase.child("story_by_date/" + today).on("value", function(snapshot) {
        var storiesMap = snapshot.val();
        var storiesArray = Object.keys(storiesMap).map(function (key) { return storiesMap[key]; });
        storiesArray = _.sortBy(storiesArray, function(story) { return -story.score; });
        storiesArray = _.first(storiesArray, 10);
        console.log("** data", storiesArray);
        self.stories =  storiesArray;
        self.date = today;
      });
    },
    
    storyUrl: function(storyId) {
      return "https://news.ycombinator.com/item?id=" + storyId;
    }

  });
</script>
